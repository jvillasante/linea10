#!/bin/sh

echo Starting Genera scripts
hostname -F /usr/local/bin/hostname

source /usr/local/bin/profile                                                        

# Call web server
/usr/sbin/httpd -p 80 -h /usr/local/bin/www

# NTP
NTP_IP=200.54.149.19
if ping -c 1 $NTP_IP &> /dev/null
then
  echo "ntp is up"
  
  # TIME ZONE update
  if [ -f /etc/localtime ]; then
    cp -p /etc/localtime /etc/localtime.bak
    ln -sf /usr/local/bin/Santiago /etc/localtime
  else
    cp /usr/local/bin/Santiago /etc/localtime
  fi
  
  # start up ntp
  ntpd -p $NTP_IP
  
  # flag to know that ntp is running
  touch /usr/local/bin/Resources/ntp_is_running
else
  echo "ntp is down"
  
  if [ -f /etc/localtime ]; then
    rm -f /etc/localtime
  fi

  # delete ntp flag
  if [ -f /usr/local/bin/Resources/ntp_is_running ]; then
    rm -f /usr/local/bin/Resources/ntp_is_running
  fi
fi

# rename old events.db to genera.db if exists
if [ -f /mnt/jffs2/events.db ]; then
  mv /mnt/jffs2/events.db /mnt/jffs2/genera.db
fi

# Install Genera Drivers
/usr/local/bin/GeneraDriversInstall.sh

# Calibration, check for missing or empty file
if [ ! -s /mnt/jffs2/pointercal ]; then
  /usr/bin/ts_calibrate
fi

# Create folder for events backup
if [ ! -d /mnt/jffs2/backup ]; then
  mkdir /mnt/jffs2/backup
fi

# Start Genera Embedded Applications
mkfifo /tmp/app.log 

if [ -n "$BOARD" ]; then
	if [ "$BOARD" == "cerebro" ]; then
    nohup /usr/local/bin/GeneraApp -qws -display transformed:Rot270 2>&1 | /usr/local/bin/ftee /tmp/app.log &
    sleep 30 
    nohup /usr/local/bin/updater 2>&1 | /usr/local/bin/ftee /tmp/app.log &
    nohup /usr/local/bin/synchronizer 2>&1 | /usr/local/bin/ftee /tmp/app.log &
    nohup /usr/local/bin/backup 2>&1 | /usr/local/bin/ftee /tmp/app.log &
		exit
	elif [ "$BOARD" == "ultragate" ]; then
		# nohup  /usr/local/bin/KAIROSApp -qws  2>&1 | /usr/local/bin/ftee /tmp/app.log &
		exit
	fi
fi

